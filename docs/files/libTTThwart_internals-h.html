<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>libTTThwart_internals.h</title><link rel="stylesheet" type="text/css" href="../styles/main.css" /><script type="text/javascript" src="../styles/main.js"></script><script type="text/javascript">NDLoader.LoadJS("Content", "../styles/");</script></head>

<!-- Generated by Natural Docs, version 2.0.2 -->

<!-- saved from url=(0016)http://localhost -->

<body onload="NDLoader.OnLoad('Content');" class="NDPage NDContentPage">

<a name="Information"></a><a name="Topic32"></a><div class="CTopic TGroup LC first">
 <div class="CTitle">Information</div>
</div>

<a name="License"></a><a name="Topic25"></a><div class="CTopic TInformation LC">
 <div class="CTitle">License</div>
 <div class="CBody"><p>Copyright 2019 Razvan Raducu and Ricardo J. Rodriguez</p><p>This file is part of libTTThwart.so.</p><p>libTTThwart.so is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p><p>libTTThwart.so is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&nbsp; See the GNU General Public License for more details.</p><p>You should have received a copy of the GNU General Public License along with libTTThwart.so.&nbsp; If not, see <a href="https://www.gnu.org/licenses/" target="_top">https://&#8203;www&#8203;.gnu&#8203;.org&#8203;/licenses&#8203;/</a>.</p><div class="CHeading">Authors</div><p><a href="https://twitter.com/Razvieu" target="_top">Razvan Raducu</a></p><div class="CHeading">Academic coordinator</div><p><a href="https://webdiis.unizar.es/~ricardo/" target="_top">Ricardo J. Rodr√≠guez</a></p><div class="CHeading">Code</div><p>You can find the source code associated with this header <a href="https://github.com/RazviOverflow/ld.so.preload/blob/master/src/libTTThwart_internals.c" target="_top">here</a>.</p></div>
</div>

<a name="Constants"></a><a name="Topic34"></a><div class="CTopic TGroup LC">
 <div class="CTitle">Constants</div>
</div>

<a name="GET_PROGRAM_NAME"></a><a name="Topic35"></a><div class="CTopic TConstant LC">
 <div class="CTitle">GET_PROGRAM_NAME()</div>
 <div class="CBody"><p>Function used to retrieve the actual program's name.</p></div>
</div>

<a name="Functions"></a><a name="Topic36"></a><div class="CTopic TGroup LC">
 <div class="CTitle">Functions</div>
</div>

<a name="check_parameters_properties"></a><a name="Topic38"></a><div class="CTopic TFunction LC">
 <div class="CTitle">check_parameters_properties</div>
 <div id="NDPrototype38" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> check_parameters_properties(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">path,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">caller_function_name</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Checks properties of the given parameters, this is, the given path and inode. Checking properties in this context means checking if a <a href="../index.html#File:libTTThwart_file_objects_info.h:file_object_info" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,58);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >file_object_info</a> with the same path already exists in the array. If it doesn't, insert it; othwerwise (if it does) compare the given inode and the inode of the <a href="../index.html#File:libTTThwart_file_objects_info.h:file_object_info" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,58);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >file_object_info</a> as well as the file mode and the device id. If they're equal continue execution; otherwise abort execution because a possible TOCTTOU is detected.</p><p>Checking parameters is different based on the FILE SYSTEM of the given path.&nbsp; At the moment, the function only considers two file systems:</p><ul><li><p>EXT2/EXT3/EXT4 (their magic number is the same). When the path is located in a ext2/3/4 file system, temporal hardlinks are created in order to ensure the inode is not reused. One &quot;feature&quot; of such filesystems is that they reuse inode as soon as a given inode has 0 links pointing to it.</p></li><li><p>OTHER FS. When the path is allocated on any other possible file system the checkings performed are the same with the exception of temporal hard links creation. We do not need hard links because inodes are not reused.</p></li></ul><p>In order to see this function initialization, please refer to <a href="../index.html#File:libTTThwart_internals.h:get_fs_and_initialize_checking_functions" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,42);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >get_fs_and_initialize_checking_functions</a>.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">path<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>absolute path of the file whose metadata must be checked.</p></td></tr><tr><td class="CDLEntry">caller_function_name<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>name of the function from which the checking was called.</p></td></tr></table></div>
</div>

<a name="sanitize_and_get_absolute_path"></a><a name="Topic39"></a><div class="CTopic TFunction LC">
 <div class="CTitle">sanitize_and_get_absolute_path</div>
 <div id="NDPrototype39" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span> * sanitize_and_get_absolute_path(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PType first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PName last">char *</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function to get full path of a given parameter without resolving, expanding symbolic links. That's why realpath() is useless.&nbsp; Based on: <a href="https://stackoverflow.com/questions/4774116/realpath-without-resolving-symlinks/34202207#34202207" target="_top">https://&#8203;stackoverflow&#8203;.com&#8203;/questions&#8203;/4774116&#8203;/realpath-without-resolving-symlinks&#8203;/34202207&#8203;#34202207</a></p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">src</td><td class="CDLDefinition"><p>Path to sanitize and absolutize.</p></td></tr></table><div class="CHeading">Returns</div><p>The sanitized and absolutized path.</p></div>
</div>

<a name="sanitize_and_get_absolute_path_from_dir_file_descriptor"></a><a name="Topic40"></a><div class="CTopic TFunction LC">
 <div class="CTitle">sanitize_and_get_absolute_path_from_dir_file_descriptor</div>
 <div id="NDPrototype40" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span> * sanitize_and_get_absolute_path_from_dir_file_descriptor(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">src,</td></tr><tr><td class="first"></td><td class="PType"><span class="SHKeyword">int</span>&nbsp;</td><td></td><td class="PName last">directory_fd</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function to get full path of a given parameter without resolving, expanding symbolic links but using a directory file descriptor as current working dir.&nbsp; It is assumed that the file is indeed within that directory. The function translates the file descriptor into the actual directory (string).</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">src<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Path to sanitize according to directory_fd.</p></td></tr><tr><td class="CDLEntry">directory_fd<div class="CDLParameterType"><span class="SHKeyword">int</span></div></td><td class="CDLDefinition"><p>File descriptor pointing to certain directroy.</p></td></tr></table><div class="CHeading">Returns</div><p>The sanitized function according to directory_fd.</p></div>
</div>

<a name="get_directory_from_fd"></a><a name="Topic41"></a><div class="CTopic TFunction LC">
 <div class="CTitle">get_directory_from_fd</div>
 <div id="NDPrototype41" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">char</span> * get_directory_from_fd(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PType first"><span class="SHKeyword">int</span>&nbsp;</td><td class="PName last">directory_fd</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to retrieve as string the full directory path pointed to by a given file descriptor.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">directory_fd<div class="CDLParameterType"><span class="SHKeyword">int</span></div></td><td class="CDLDefinition"><p>File descriptor pointing to some directroy.</p></td></tr></table><div class="CHeading">Returns</div><p>The name of the directory pointed to by directory_fd.</p></div>
</div>

<a name="get_fs_and_initialize_checking_functions"></a><a name="Topic42"></a><div class="CTopic TFunction LC">
 <div class="CTitle">get_fs_and_initialize_checking_functions</div>
 <div id="NDPrototype42" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> get_fs_and_initialize_checking_functions(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">path</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Determines what the file system of a given path is and, based on that, initialize <a href="../index.html#File:libTTThwart_internals.h:check_parameters_properties" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,38);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >check_parameters_properties</a> function accordingly. Please refer to that function in order to know what different initializations means.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">path<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Absolute or relative path whose filesystem must be retrieved.</p></td></tr></table></div>
</div>

<a name="check_dlsym_error"></a><a name="Topic43"></a><div class="CTopic TFunction LC">
 <div class="CTitle">check_dlsym_error</div>
 <div id="NDPrototype43" class="NDPrototype NoParameterForm"><span class="SHKeyword">void</span> check_dlsym_error()</div>
 <div class="CBody"><p>Just a wrapper to check dlsym errors. This wrapper complies wit the recommendations given at the <a href="http://man7.org/linux/man-pages/man3/dlsym.3.html" target="_top">offical documentation</a>.</p></div>
</div>

<a name="print_function_and_path"></a><a name="Topic44"></a><div class="CTopic TFunction LC">
 <div class="CTitle">print_function_and_path</div>
 <div id="NDPrototype44" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> print_function_and_path(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">func,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">path,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">sanitized_path</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to log what function was called, what path it was called with and its sanitized version.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">func<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Function that was originally called.</p></td></tr><tr><td class="CDLEntry">path<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>What path is was passwed into as parameter.</p></td></tr><tr><td class="CDLEntry">sanitized_path<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Sanitized path of &lt;path&gt; argument.</p></td></tr></table></div>
</div>

<a name="get_number_of_variable_arguments_char_pointer_type"></a><a name="Topic45"></a><div class="CTopic TFunction LC">
 <div class="CTitle">get_number_of_variable_arguments_char_pointer_type</div>
 <div id="NDPrototype45" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">int</span> get_number_of_variable_arguments_char_pointer_type(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PType first">va_list&nbsp;</td><td class="PName last">variable_arguments</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to calculate the number of arguments given a variable char argument list.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">variable_arguments<div class="CDLParameterType">va_list</div></td><td class="CDLDefinition"><p>List of variable arguments to go across.</p></td></tr></table><div class="CHeading">Returns</div><p>The number of char parameters.</p></div>
</div>

<a name="get_inode"></a><a name="Topic46"></a><div class="CTopic TFunction LC">
 <div class="CTitle">get_inode</div>
 <div id="NDPrototype46" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters">ino_t get_inode(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">path</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to get the corresponding inode of a given path.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">path<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Path whose inode must be retrieved.</p></td></tr></table><div class="CHeading">Returns</div><p>The inode.</p></div>
</div>

<a name="path_is_absolute"></a><a name="Topic47"></a><div class="CTopic TFunction LC">
 <div class="CTitle">path_is_absolute</div>
 <div id="NDPrototype47" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">bool</span> path_is_absolute(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">path</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to determine whether a path is absolute.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">path<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Path to check whether it's absolute.</p></td></tr></table><div class="CHeading">Returns</div><p>True if path is asbolute; otherwise False.</p></div>
</div>

<a name="file_does_exist"></a><a name="Topic48"></a><div class="CTopic TFunction LC">
 <div class="CTitle">file_does_exist</div>
 <div id="NDPrototype48" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">int</span> file_does_exist(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">pathname</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to determine whether a file exists at the moment of invocation.&nbsp; In order to do so, it calls &lt;open&gt; and check the value of the returned file descriptior.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">pathname<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Path of the file to check.</p></td></tr></table><div class="CHeading">Returns</div><p>0 for false.&nbsp; 1 for true.</p></div>
</div>

<a name="remove_directory_and_content"></a><a name="Topic49"></a><div class="CTopic TFunction LC">
 <div class="CTitle">remove_directory_and_content</div>
 <div id="NDPrototype49" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">int</span> remove_directory_and_content(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PType first"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">path_to_remove</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Funcrtion used to recursively delete a given directory.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">path_to_remove<div class="CDLParameterType"><span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Path to recorsively remove.</p></td></tr></table><div class="CHeading">Returns</div><p>Value indicating whethere there were errors.</p></div>
</div>

<a name="get_file_metadata"></a><a name="Topic50"></a><div class="CTopic TFunction LC">
 <div class="CTitle">get_file_metadata</div>
 <div id="NDPrototype50" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">struct</span> stat get_file_metadata(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">path</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to retrieve metadata of a given path. In order to do so, the function calls &lt;open&gt;.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">path<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Path whose metadata must be retrieved.</p></td></tr></table><div class="CHeading">Returns</div><p>struct stat containing all the metadata of the given path.</p></div>
</div>

<a name="starts_with"></a><a name="Topic51"></a><div class="CTopic TFunction LC last">
 <div class="CTitle">starts_with</div>
 <div id="NDPrototype51" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">bool</span> starts_with(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">pre,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">const</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">str</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Function used to check whether the given str parameter start with the given pre parameter.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">pre<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Preffix to check.</p></td></tr><tr><td class="CDLEntry">str<div class="CDLParameterType"><span class="SHKeyword">const</span> <span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>String to check if starts with &quot;pre&quot;.</p></td></tr></table><div class="CHeading">Returns</div><p>True if str starts with pre.&nbsp; False otherwise.</p></div>
</div>

</body></html>